# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: ECMS

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]
  workflow_dispatch:
    inputs:
      target_branch:
        type: string
        default: develop
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name:  ƒêƒÉng nh·∫≠p v√†o GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: üì¶ X√¢y d·ª±ng v√† ƒê·∫©y Image l√™n GHCR
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: | 
          ghcr.io/ecms:latest
          ghcr.io/ecms:${{github.sha}}    
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: üö¢ Tri·ªÉn khai Docker tr√™n VPS
      uses: appleboy/ssh-action@v1.0.1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. ƒê·ªãnh nghƒ©a c√°c bi·∫øn c·∫ßn thi·∫øt
          IMAGE_TAG="ghcr.io/ecms:${{ github.sha }}"
          CONTAINER_NAME="ecms-app"
          
          # 2. K√©o (Pull) Image m·ªõi nh·∫•t t·ª´ GHCR
          echo "B·∫Øt ƒë·∫ßu k√©o Image: $IMAGE_TAG"
          sudo docker pull $IMAGE_TAG
          
          # 3. D·ªçn d·∫πp Container c≈© (D·ª´ng v√† X√≥a)
          # L·ªánh n√†y s·∫Ω d·ª´ng v√† x√≥a container c≈© n·∫øu n√≥ t·ªìn t·∫°i
          echo "ƒêang d·ª´ng v√† x√≥a Container c≈©..."
          sudo docker rm -f $CONTAINER_NAME || true 
          
          # 4. Ch·∫°y Container m·ªõi (Mapping Port v√† ch·∫°y n·ªÅn)
          # Gi·∫£ s·ª≠ ·ª©ng d·ª•ng .NET ch·∫°y n·ªôi b·ªô tr√™n port 8080
          echo "ƒêang kh·ªüi ƒë·ªông Container m·ªõi..."
          sudo docker run -d \
            --name $CONTAINER_NAME \
            -p 80:8080 \
            $IMAGE_TAG
          
          # 5. Ki·ªÉm tra tr·∫°ng th√°i (t√πy ch·ªçn)
          sudo docker ps -a
    
