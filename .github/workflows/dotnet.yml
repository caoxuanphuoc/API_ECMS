# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: ECMS

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]
  workflow_dispatch:
    inputs:
      target_branch:
        type: string
        default: develop
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: check git
      run: git branch
    - name: Restore dependencies
      working-directory: 8.4.0/aspnet-core
      run: dotnet restore
    - name: Build
      working-directory: 8.4.0/aspnet-core
      run: dotnet build ECMS.sln --no-restore
    - name: Publish .NET Artifact
      working-directory: 8.4.0/aspnet-core
      run: dotnet publish src/ECMS.Web.Host/ECMS.Web.Host.csproj -o ecms_build 
    - name: Upload Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ecms_build_artifact
        path: 8.4.0/aspnet-core/ecms_build
  deploy:
    runs-on: ubuntu-latest
    needs: build # üëà Ch·ªâ ch·∫°y khi Job 'build' th√†nh c√¥ng

    steps:
    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: ecms_build_artifact # üëà T√™n Artifact ƒë√£ upload
        
    - name: Debug Check Downloaded Artifact Path
      run: ls -R
      
    - name: Transfer Artifact to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ./* # üëà Th∆∞ m·ª•c Artifact ƒë√£ t·∫£i v·ªÅ
        target: /var/www/ecms-app/
    - name: Deploy Script (Service Management)
      uses: appleboy/ssh-action@v1.0.1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥ (An to√†n cho l·∫ßn ƒë·∫ßu)
          mkdir -p /var/www/ecms-app/
          
          # 2. Chuy·ªÉn file: SCP Action ƒë√£ chuy·ªÉn file v√†o /var/www/ecms-app/
          #    (Kh√¥ng c·∫ßn l·ªánh copy file ·ªü ƒë√¢y n·ªØa)
          
          # 3. Qu·∫£n l√Ω d·ªãch v·ª• (Service Management)
          #    L·ªánh n√†y ch·ªâ ch·∫°y n·∫øu d·ªãch v·ª• ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t
          sudo systemctl stop ECMS.service 
          sudo systemctl start ECMS.service
    
